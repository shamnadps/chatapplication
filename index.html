
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <!--[if IE]>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <![endif]-->
    <title>Leadin Chat Box</title>
	<link href="bootstrap.css" rel="stylesheet" />
    <!-- FONT AWESOME  CSS -->
    <link href="font-awesome.css" rel="stylesheet" />
    <!-- CUSTOM STYLE CSS -->
    <link href="styles.css" rel="stylesheet" />


</head>
<body>
    <div class="container">
        <div class="row pad-top pad-bottom">


            <div class=" col-lg-6 col-md-6 col-sm-6">
                <div class="chat-box-div">
                    <div class="chat-box-head">
                        GROUP CHAT
                    </div>
					<div>
                        <div class="input-group" id="nickbox">
                            <input type="text" id="name" class="form-control" placeholder="Enter Nickname Here...">
                            <span class="input-group-btn">
								<input type="button" class="btn btn-info" id="getnick" onclick="sendNick()" value="SEND"/>
                            </span>
                        </div>
							
						<div class="panel-body chat-box-new">
							<div id="welcome"></div>
							
							<div id="messages"></div>
						</div>

                    </div>
                    <div id="chatmessages" class="panel-body chat-box-main">
                    </div>
                    <div class="chat-box-footer">
                        <div class="input-group">
                            <input type="text" class="form-control" id="chat" placeholder="Enter Text Here...">
                            <span class="input-group-btn">
								<input type="button" class="btn btn-info" id="sendchat" onclick="sendChat()" value="SEND"/>
                            </span>
                        </div>
                    </div>

                </div>

            </div>
            <div class="col-lg-3 col-md-3 col-sm-3">
                <div class="chat-box-online-div">
                    <div class="chat-box-online-head">
                        LEADIN CHAT MEMBERS
                    </div>
                    <div id="membersonline" class="panel-body chat-box-online">
                    </div>

                </div>

            </div>
            <div class="col-lg-3 col-md-3 col-sm-3">
                <div class="chat-box-new-div">
                    <div class="chat-box-new-head">
                        Notifications
                    </div>
                    <div class="panel-body chat-box-new">


                        <div id="messagesfromserver">
						</div>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- USING SCRIPTS BELOW TO REDUCE THE LOAD TIME -->
    <!-- CORE JQUERY SCRIPTS FILE -->
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
		<script>
	$("#getnick").prop('disabled', true);
	$("#sendchat").prop('disabled', true);
	websocket = new WebSocket("ws://127.0.0.1:8888");

	function sendNick() {
		name = $('#name').val() ? $('#name').val() : 'Anonymous';
		$('#nickbox').hide();
		$('#welcome').text('Welcome ' + name);
		$('#welcome').append('<hr class="hr-clas-low" />');
		websocket.send("/nick "+name);
		$("#sendchat").prop('disabled', false);
		$('#messages').html("Successfully Registerd Nick name, Start Chatting now!.");
	}

	function sendChat() {

		name = $('#name').val() ? $('#name').val() : 'Anonymous';
		chat = $('#chat').val();
		websocket.send(chat);
		$('#chat').focus();
		$('#chat').val('');
		var name = 'You';
		buildChatItem(name, chat);
	}
	
	function buildChatItem(name,chat) {
		var chatmessage = '<div class="chat-box-left">'+chat+'</div>';
		var chatuser = '<div class="chat-box-name-left"><img src="user.png" alt="bootstrap Chat box user image" class="img-circle" /> -  '+name+'</div>';
        var hrline = '<hr class="hr-clas" />';
		$('#chatmessages').append(chatmessage+chatuser+hrline);
	}
	
	function buildMemberlist(name,online) {
		var username = '<div class="chat-box-online-left"><img src="user.png" alt="user image" class="img-circle" /> -  '+name+'<br />';
		var active = '(<small>Active</small>)';
		var offline = '(<small>Offline</small>)';
        var showhistory = ' <small> <a href="#" id="link'+name+'" onclick="showChatHistory(\''+name+'\')">History</a></small></div>';
		var chatHistory = '<div id="chathistorymessages'+name+'" class="panel-body chat-box-main chat-history" style="display:none;"></div><hr class="hr-clas" />';
		
		if(online) {
			$('#membersonline').prepend(username+active+showhistory+chatHistory);
		} else {
			$('#membersonline').append(username+offline+showhistory+chatHistory);
		}
		
	}
	var firstmessage = 0;
	websocket.onmessage = function(evt) {
		if( firstmessage == 1) {
			var json = JSON.parse(evt.data);
			if(json.error) {
				handleErrorMessage(json.error);
				return;
			}
			if(json.from == '_server') {
				$('#messagesfromserver').append(json.message+'<hr class="hr-clas-low" />');
				var getusersurl = "http://localhost:8888/users";
				jQuery.ajax({
					url: getusersurl,
					type: "GET",
					dataType: "text",
					success: function(resultData) {
						var jsonobj = $.parseJSON(resultData);
						var jsonConvertedData = JSON.stringify(jsonobj.data);
						processMemberData(jsonConvertedData);
					},
					error : function(jqXHR, textStatus, errorThrown) {
					},
				});
			} else {
				buildChatItem(json.from,json.message);
			}
		} else {
			firstmessage = 1;
			$('#messages').html("Register your nickname.");
		}
		$("#getnick").prop('disabled', false);
	};

	websocket.onerror = function(evt) {
		$('#messages').html("Connection Lost! Please start the server.");
	};

	function handleErrorMessage(message) {
		if(message == 'Nick in use') {
			$('#messages').html("Nickname already in use. Please try a different one!");
		} else if(message == 'Nick cannot start with the underscore'){
			$('#messages').html("Nick cannot start with the underscore. Please try a different one!");
		}
		$('#nickbox').show();
		$('#welcome').text(' ');
		$("#sendchat").prop('disabled', true);
	}

	function processMemberData(data) {
		data = $.parseJSON(data);
		$('#membersonline').empty();
		name = $('#name').val() ? $('#name').val() : 'Anonymous';
		$.each(data, function(i, item) {
			var row = JSON.stringify(item);
			if(name != item.nick) {
				buildMemberlist(item.nick, item.online);
			}
		});
	}

	function showChatHistory(names) {
		var getusersurl = "http://localhost:8888/history";
		var txt = $('#link'+names).text();
		if(txt == 'History') {
			$('#link'+names).html = 'Hide';
		} else {
			$('#link'+names).html = 'History';
		}
		jQuery.ajax({
			url: getusersurl,
			type: "GET",
			dataType: "text",
			success: function(resultData) {
				var jsonobj = $.parseJSON(resultData);
				var jsonConvertedData = JSON.stringify(jsonobj.data);
				processHistoryData(jsonConvertedData,names);
			},
			error : function(jqXHR, textStatus, errorThrown) {
			},
		});
	}

	function processHistoryData(data,name) {
	
		$('#chathistorymessages'+name).toggle();
		data = $.parseJSON(data);
		$('#chathistorymessages'+name).empty();
		var counter = 0;
		$.each(data, function(i, item) {
			var row = JSON.stringify(item);
			if(name == item.from) {
				counter++;
				if(counter == 1) {
					$('#chathistorymessages'+name).prepend('<small>Showing chat history with '+name+'</small><hr>');
				}
				var timestamp = item.timestamp;
				var formatTime = new Date(timestamp);
				buildChatHistory(item.from,item.msg);
			}
		});
		if(counter == 0) {
			$('#chathistorymessages'+name).html("No messages from user "+name);
		}
	}
	
	function buildChatHistory(name,chat) {
		var chatmessage = '<div class="chat-box-left">'+chat+'</div>';
		var chatuser = '<div class="chat-box-name-left"><img src="user.png" alt="bootstrap Chat box user image" height="30" width="30" class="img-circle" /> -  '+name+'</div>';
        var hrline = '<hr class="hr-clas-low" />';
		$('#chathistorymessages'+name).append(chatmessage+chatuser+hrline);
	}

	function formatTimeString(formatTime) {
		return '<span style="float:right;margin-right:10px;">'+formatTime.getHours()+":"+formatTime.getMinutes()+":"+formatTime.getSeconds()+'</span>';
	}
	</script>

</body>

</html>
