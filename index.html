<!doctype html>
<html>

<head>
    <title>WebSocket Chat</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>

<body>

	<div id="signedusers">
		<div id="title">
			Leadin Chat Members
		</div>
		<hr>
		<div id="membernames">
			<ul id="membernamelist"></ul>
		</div>
		<hr>
		<div id="notificationbar">
			Notifications
		</div>
		<hr>
		<div id="servermessages">
			<ul id="messagesfromserver"></ul>
		</div>
		<hr>
	</div>
	<form>
		<div id="name-div">
			<input id="name" name="name" autocomplete="off" autofocus placeholder="Enter your nickname" />
			<input type="button" id="getnick" value="Set Username" onClick="getNick()"/>
		</div>
		<div id="welcome"></div>
		<ul id="messages"></ul>
		<div id="input-div">
			<input id="message" name="message" autocomplete="off" placeholder="Type your message here" />
			<input type="button" id="sendchat" value="Send" onclick="sendChat()"/>
		</div>
	</form>

	<script>
	$("#getnick").prop('disabled', true);
	$("#sendchat").prop('disabled', true);
	websocket = new WebSocket("ws://127.0.0.1:8888");

	function getNick() {
		name = $('#name').val() ? $('#name').val() : 'Anonymous';
		$('#name-div').hide();
		$('#welcome').text('Welcome ' + name);
		websocket.send("/nick "+name);
		$("#sendchat").prop('disabled', false);
		$('#messages').html($('<li>').html("Successfully Registerd Nick name, Start Chatting now!."));
	}

	function sendChat() {
		name = $('#name').val() ? $('#name').val() : 'Anonymous';
		message = $('#message').val();
		websocket.send(message);
		$('#message').focus();
		$('#message').val('');
		$('#messages').append($('<li>').html('<span id="username">You: </span>'+message));
	}
	var firstmessage = 0;
	websocket.onmessage = function(evt) {
		if( firstmessage == 1) {
			var json = JSON.parse(evt.data);
			if(json.error) {
				handleErrorMessage(json.error);
				return;
			}
			if(json.from == '_server') {
				$('#messagesfromserver').append($('<li>').html(json.message));
				var getusersurl = "http://localhost:8888/users";
				jQuery.ajax({
					url: getusersurl,
					type: "GET",
					dataType: "text",
					success: function(resultData) {
						var jsonobj = $.parseJSON(resultData);
						var jsonConvertedData = JSON.stringify(jsonobj.data);
						processMemberData(jsonConvertedData);
					},
					error : function(jqXHR, textStatus, errorThrown) {
					},
				});
			} else {
				$('#messages').append($('<li>').html('<span id="username">'+json.from+": </span>"+json.message));
			}
		} else {
			firstmessage = 1;
			$('#messages').append($('<li>').html("Register your nickname."));
		}
		$("#getnick").prop('disabled', false);
	};

	websocket.onerror = function(evt) {
		$('#messages').append($('<li>').text("Connection Lost! Please start the server."));
	};

	function handleErrorMessage(message) {
		if(message == 'Nick in use') {
			$('#messages').html($('<li>').html("Nickname already in use. Please try a different one!"));
		} else if(message == 'Nick cannot start with the underscore'){
			$('#messages').html($('<li>').html("Nick cannot start with the underscore. Please try a different one!"));
		}
		$('#name-div').show();
		$('#welcome').text(' ');
		$("#sendchat").prop('disabled', true);
	}

	function processMemberData(data) {
		data = $.parseJSON(data);
		$('#membernamelist').empty();
		name = $('#name').val() ? $('#name').val() : 'Anonymous';
		$.each(data, function(i, item) {
			var row = JSON.stringify(item);
			if(name != item.nick) {
				if(item.online) {
					$('#membernamelist').prepend($('<li>').html(getOnlineStatus(item.online) + getName(item.nick) + getChatHistory(item.nick)));
				} else {
					$('#membernamelist').append($('<li>').html(getOnlineStatus(item.online) + getName(item.nick) + getChatHistory(item.nick)));
				}
			}
		});
	}

	function getOnlineStatus(online) {
		return '<img src="'+checkStatus(online)+'" height="25" width="25">';
	}

	function getName(name) {
		return '<span style="margin-left:4px;margin-bottom:10px;">' + name +' </span>';
	}

	function getChatHistory(name) {
		return '<img style="margin-right:10px;float:right;cursor: pointer;" onclick="showChatHistory(\'' + name + '\')" title="Chat History" src="chathistory.png" height="21" width="21">'
	}

	function checkStatus(status) {
		if(status) {
			return 'online.png';
		} else {
			return 'offline.png';
		}
	}

	function showChatHistory(names) {
		var getusersurl = "http://localhost:8888/history";
		jQuery.ajax({
			url: getusersurl,
			type: "GET",
			dataType: "text",
			success: function(resultData) {
				var jsonobj = $.parseJSON(resultData);
				var jsonConvertedData = JSON.stringify(jsonobj.data);
				processHistoryData(jsonConvertedData,names);
			},
			error : function(jqXHR, textStatus, errorThrown) {
			},
		});
	}

	function processHistoryData(data,name) {
		data = $.parseJSON(data);
		$('#messages').empty();
		var counter = 0;
		$.each(data, function(i, item) {
			var row = JSON.stringify(item);
			if(name == item.from) {
				counter++;
				if(counter == 1) {
					$('#messages').prepend($('<li>').html('Showing chat history with '+name));
				}
				var timestamp = item.timestamp;
				var formatTime = new Date(timestamp);
				$('#messages').append($('<li>').html('<span id="username">'+item.from+': </span> '+item.msg+' '+formatTimeString(formatTime)));
			}
		});
		if(counter == 0) {
			$('#messages').append($('<li>').html("No messages from user "+name));
		}
	}

	function formatTimeString(formatTime) {
		return '<span style="float:right;margin-right:10px;">'+formatTime.getHours()+":"+formatTime.getMinutes()+":"+formatTime.getSeconds()+'</span>';
	}
	</script>
</body>

</html>